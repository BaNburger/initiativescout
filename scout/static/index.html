<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Scout — Outreach Intelligence</title>
<style>
:root {
  --bg: #0f1117;
  --surface: #1a1d27;
  --surface-2: #242836;
  --border: #2e3345;
  --ink: #e4e7ef;
  --ink-dim: #8b90a0;
  --ink-faint: #555a6e;
  --green: #22c55e;
  --green-bg: #0a2a1a;
  --blue: #3b82f6;
  --blue-bg: #0c1a3a;
  --amber: #f59e0b;
  --amber-bg: #2a1f08;
  --gray: #6b7280;
  --gray-bg: #1a1d22;
  --red: #ef4444;
  --accent: #8b5cf6;
  --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  --mono: 'SF Mono', 'Fira Code', monospace;
  --radius: 8px;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: var(--font); background: var(--bg); color: var(--ink); font-size: 14px; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
a { color: var(--blue); text-decoration: none; }

/* --- Header --- */
.header { display: flex; align-items: center; justify-content: space-between; padding: 12px 20px; border-bottom: 1px solid var(--border); background: var(--surface); }
.header h1 { font-size: 18px; font-weight: 600; letter-spacing: -0.5px; }
.header-actions { display: flex; gap: 8px; }

/* --- Stats bar --- */
.stats-bar { display: flex; gap: 16px; padding: 10px 20px; border-bottom: 1px solid var(--border); background: var(--surface); font-size: 13px; }
.stat { display: flex; align-items: center; gap: 6px; color: var(--ink-dim); }
.stat strong { color: var(--ink); font-variant-numeric: tabular-nums; }

/* --- Filters --- */
.filters { display: flex; gap: 8px; padding: 10px 20px; border-bottom: 1px solid var(--border); background: var(--surface); flex-wrap: wrap; align-items: center; }
.filter-select, .search-input { background: var(--surface-2); border: 1px solid var(--border); color: var(--ink); padding: 6px 10px; border-radius: var(--radius); font-size: 13px; outline: none; }
.filter-select:focus, .search-input:focus { border-color: var(--accent); }
.search-input { width: 200px; }

/* --- Main layout --- */
.main { display: flex; flex: 1; overflow: hidden; }

/* --- List panel --- */
.list-panel { flex: 0 0 55%; overflow-y: auto; border-right: 1px solid var(--border); }
.list-table { width: 100%; border-collapse: collapse; }
.list-table th { position: sticky; top: 0; background: var(--surface); padding: 10px 12px; text-align: left; font-size: 12px; font-weight: 500; color: var(--ink-dim); text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid var(--border); cursor: pointer; user-select: none; }
.list-table th:hover { color: var(--ink); }
.list-table td { padding: 10px 12px; border-bottom: 1px solid var(--border); vertical-align: middle; }
.list-table tr { cursor: pointer; transition: background 0.1s; }
.list-table tbody tr:hover { background: var(--surface-2); }
.list-table tbody tr.selected { background: var(--surface-2); border-left: 3px solid var(--accent); }
.list-table .name-cell { font-weight: 500; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.list-table .uni-cell { font-size: 12px; color: var(--ink-dim); }
.list-table .sector-cell { font-size: 12px; color: var(--ink-dim); max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.list-table .score-cell { font-variant-numeric: tabular-nums; font-weight: 600; }

/* Verdict badges */
.verdict-badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
.verdict-reach_out_now { background: var(--green-bg); color: var(--green); }
.verdict-reach_out_soon { background: var(--blue-bg); color: var(--blue); }
.verdict-monitor { background: var(--amber-bg); color: var(--amber); }
.verdict-skip { background: var(--gray-bg); color: var(--gray); }
.verdict-unscored { background: var(--surface-2); color: var(--ink-faint); }

/* Classification badges */
.class-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 11px; color: var(--ink-dim); background: var(--surface-2); }

/* --- Detail panel --- */
.detail-panel { flex: 1; overflow-y: auto; padding: 20px; }
.detail-empty { display: flex; align-items: center; justify-content: center; height: 100%; color: var(--ink-faint); font-size: 15px; }
.detail-header { margin-bottom: 20px; }
.detail-header h2 { font-size: 20px; font-weight: 600; margin-bottom: 4px; }
.detail-header .meta { font-size: 13px; color: var(--ink-dim); display: flex; gap: 12px; flex-wrap: wrap; }
.detail-section { margin-bottom: 20px; }
.detail-section h3 { font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--ink-dim); margin-bottom: 8px; }
.detail-section p, .detail-section li { font-size: 14px; line-height: 1.6; }
.detail-section ul { padding-left: 18px; }
.detail-section li { margin-bottom: 4px; }
.detail-verdict { padding: 16px; border-radius: var(--radius); margin-bottom: 16px; }
.detail-verdict.reach_out_now { background: var(--green-bg); border: 1px solid #1a5c35; }
.detail-verdict.reach_out_soon { background: var(--blue-bg); border: 1px solid #1a3a6e; }
.detail-verdict.monitor { background: var(--amber-bg); border: 1px solid #5c4a1a; }
.detail-verdict.skip { background: var(--gray-bg); border: 1px solid #3a3d44; }
.detail-verdict .verdict-label { font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
.detail-verdict .reasoning { font-size: 14px; line-height: 1.5; }

.contact-card { background: var(--surface-2); border: 1px solid var(--border); border-radius: var(--radius); padding: 14px; margin-bottom: 16px; }
.contact-card .label { font-size: 11px; font-weight: 600; text-transform: uppercase; color: var(--ink-dim); margin-bottom: 4px; }
.contact-card .value { font-size: 14px; }

.hook-card { background: var(--surface-2); border-left: 3px solid var(--accent); border-radius: 0 var(--radius) var(--radius) 0; padding: 14px; margin-bottom: 16px; font-style: italic; line-height: 1.5; }

.detail-actions { display: flex; gap: 8px; margin-top: 16px; }

/* --- Buttons --- */
.btn { padding: 7px 14px; border-radius: var(--radius); border: 1px solid var(--border); background: var(--surface-2); color: var(--ink); cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.15s; }
.btn:hover { background: var(--border); }
.btn:disabled { opacity: 0.5; cursor: not-allowed; }
.btn-primary { background: var(--accent); border-color: var(--accent); color: white; }
.btn-primary:hover { opacity: 0.9; }
.btn-sm { padding: 5px 10px; font-size: 12px; }

/* --- Progress bar --- */
.progress-bar-container { padding: 10px 20px; border-top: 1px solid var(--border); background: var(--surface); display: none; }
.progress-bar-container.active { display: flex; align-items: center; gap: 12px; }
.progress-bar { flex: 1; height: 6px; background: var(--surface-2); border-radius: 3px; overflow: hidden; }
.progress-bar .fill { height: 100%; background: var(--accent); transition: width 0.2s; border-radius: 3px; }
.progress-label { font-size: 12px; color: var(--ink-dim); white-space: nowrap; min-width: 180px; }

/* --- Import overlay --- */
.import-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 100; }
.import-overlay.hidden { display: none; }
.import-box { background: var(--surface); border: 2px dashed var(--border); border-radius: 16px; padding: 60px; text-align: center; max-width: 500px; }
.import-box.dragover { border-color: var(--accent); background: var(--surface-2); }
.import-box h2 { font-size: 20px; margin-bottom: 8px; }
.import-box p { color: var(--ink-dim); margin-bottom: 20px; }
.import-box input[type="file"] { display: none; }

/* --- Empty state --- */
.empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--ink-dim); gap: 12px; padding: 40px; text-align: center; }
.empty-state h2 { font-size: 18px; color: var(--ink); }

/* --- Links --- */
.link-row { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
.link-pill { font-size: 11px; padding: 2px 8px; border-radius: 10px; background: var(--surface-2); color: var(--blue); border: 1px solid var(--border); }

/* --- Domain tags --- */
.domain-pill { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin: 2px 4px 2px 0; }
.domain-pill.tech { background: var(--blue-bg); color: var(--blue); }
.domain-pill.market { background: var(--green-bg); color: var(--green); }
.domain-pill.cat { background: var(--surface-2); color: var(--ink-dim); }

/* --- Signal grid --- */
.signal-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px; }
.signal-card { background: var(--surface-2); border: 1px solid var(--border); border-radius: var(--radius); padding: 10px; }
.signal-card .signal-value { font-size: 20px; font-weight: 700; font-variant-numeric: tabular-nums; color: var(--ink); }
.signal-card .signal-label { font-size: 11px; color: var(--ink-dim); text-transform: uppercase; letter-spacing: 0.3px; margin-top: 2px; }

/* --- Grade badges --- */
.grade-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 12px; font-weight: 700; font-family: var(--mono); min-width: 28px; text-align: center; }
.grade-a { background: var(--green-bg); color: var(--green); }
.grade-b { background: var(--blue-bg); color: var(--blue); }
.grade-c { background: var(--amber-bg); color: var(--amber); }
.grade-d { background: var(--gray-bg); color: var(--gray); }

.grade-cards { display: flex; gap: 10px; margin-bottom: 16px; }
.grade-card { flex: 1; background: var(--surface-2); border: 1px solid var(--border); border-radius: var(--radius); padding: 12px; text-align: center; }
.grade-card .grade-value { font-size: 28px; font-weight: 800; font-family: var(--mono); }
.grade-card .grade-label { font-size: 11px; color: var(--ink-dim); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px; }

/* --- Pre-computed scores bar --- */
.score-bar-row { display: flex; align-items: center; gap: 10px; margin-bottom: 6px; }
.score-bar-label { font-size: 12px; color: var(--ink-dim); min-width: 100px; }
.score-bar { flex: 1; height: 8px; background: var(--surface-2); border-radius: 4px; overflow: hidden; }
.score-bar .bar-fill { height: 100%; border-radius: 4px; }
.score-bar .bar-fill.green { background: var(--green); }
.score-bar .bar-fill.blue { background: var(--blue); }
.score-bar-val { font-size: 12px; font-weight: 600; color: var(--ink); min-width: 30px; text-align: right; font-variant-numeric: tabular-nums; }

/* --- Project cards --- */
.project-card { background: var(--surface-2); border: 1px solid var(--border); border-radius: var(--radius); padding: 14px; margin-bottom: 10px; }
.project-card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
.project-card-header h4 { font-size: 14px; font-weight: 600; }
.project-card-actions { display: flex; gap: 4px; }
.project-card .project-meta { font-size: 12px; color: var(--ink-dim); line-height: 1.6; }
.project-card .project-grades { display: flex; gap: 8px; margin-top: 8px; }
.project-card .project-grades .pg-item { font-size: 11px; color: var(--ink-dim); display: flex; align-items: center; gap: 4px; }

/* --- Project form --- */
.project-form { background: var(--surface-2); border: 1px solid var(--accent); border-radius: var(--radius); padding: 16px; margin-bottom: 10px; }
.project-form .pf-row { margin-bottom: 10px; }
.project-form label { display: block; font-size: 11px; font-weight: 600; text-transform: uppercase; color: var(--ink-dim); margin-bottom: 4px; }
.project-form input, .project-form textarea { width: 100%; background: var(--bg); border: 1px solid var(--border); color: var(--ink); padding: 6px 10px; border-radius: var(--radius); font-size: 13px; font-family: var(--font); outline: none; }
.project-form input:focus, .project-form textarea:focus { border-color: var(--accent); }
.project-form textarea { resize: vertical; min-height: 60px; }
.project-form .pf-actions { display: flex; gap: 8px; margin-top: 12px; }

/* --- Inline editing (double-click to edit) --- */
.editable { border-radius: 3px; transition: outline-color 0.15s; outline: 1px dashed transparent; outline-offset: 2px; }
.editable:hover { outline-color: var(--ink-faint); }
.inline-input, .inline-select { background: var(--bg); border: 1px solid var(--accent); color: var(--ink); padding: 4px 8px; border-radius: var(--radius); font-size: inherit; font-family: inherit; width: 100%; outline: none; }
.inline-input:focus, .inline-select:focus { box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2); }
textarea.inline-input { resize: vertical; min-height: 60px; }
.edit-pencil { cursor: pointer; font-size: 11px; color: var(--ink-faint); margin-left: 4px; opacity: 0; transition: opacity 0.15s; }
.link-row:hover .edit-pencil, .edit-pencil:hover { opacity: 1; }

/* --- Column drag-and-drop --- */
.list-table th[draggable="true"] { cursor: grab; }
.list-table th[draggable="true"]:active { cursor: grabbing; }
.list-table th.drag-over { border-left: 2px solid var(--accent); background: var(--surface-2); }
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <h1>Scout</h1>
  <div class="header-actions">
    <button class="btn btn-sm" onclick="showImport()">Import XLSX</button>
    <button class="btn btn-sm" id="btn-enrich-all" onclick="enrichBatch()" disabled>Enrich All</button>
    <button class="btn btn-sm" id="btn-score-all" onclick="scoreBatch()" disabled>Score All</button>
  </div>
</div>

<!-- Stats -->
<div class="stats-bar" id="stats-bar">
  <div class="stat"><strong id="stat-total">0</strong> total</div>
  <div class="stat"><strong id="stat-enriched">0</strong> enriched</div>
  <div class="stat"><strong id="stat-scored">0</strong> scored</div>
  <div class="stat"><span class="verdict-badge verdict-reach_out_now" id="stat-now">0 reach out now</span></div>
  <div class="stat"><span class="verdict-badge verdict-reach_out_soon" id="stat-soon">0 soon</span></div>
  <div class="stat"><span class="verdict-badge verdict-monitor" id="stat-monitor">0 monitor</span></div>
</div>

<!-- Filters -->
<div class="filters">
  <select class="filter-select" id="filter-verdict" onchange="applyFilters()">
    <option value="">All Verdicts</option>
    <option value="reach_out_now">Reach Out Now</option>
    <option value="reach_out_soon">Reach Out Soon</option>
    <option value="monitor">Monitor</option>
    <option value="skip">Skip</option>
    <option value="unscored">Unscored</option>
  </select>
  <select class="filter-select" id="filter-class" onchange="applyFilters()">
    <option value="">All Types</option>
    <option value="deep_tech">Deep Tech</option>
    <option value="student_venture">Student Venture</option>
    <option value="applied_research">Applied Research</option>
    <option value="student_club">Student Club</option>
    <option value="dormant">Dormant</option>
  </select>
  <select class="filter-select" id="filter-uni" onchange="applyFilters()">
    <option value="">All Unis</option>
    <option value="TUM">TUM</option>
    <option value="LMU">LMU</option>
    <option value="HM">HM</option>
  </select>
  <input class="search-input" id="filter-search" type="text" placeholder="Search..." oninput="applyFilters()">
</div>

<!-- Main layout -->
<div class="main">
  <!-- List -->
  <div class="list-panel" id="list-panel">
    <table class="list-table">
      <thead><tr id="list-head"></tr></thead>
      <tbody id="list-body"></tbody>
    </table>
    <div class="empty-state" id="empty-state" style="display:none;">
      <h2>No initiatives loaded</h2>
      <p>Import an XLSX spreadsheet to get started</p>
      <button class="btn btn-primary" onclick="showImport()">Import XLSX</button>
    </div>
  </div>

  <!-- Detail -->
  <div class="detail-panel" id="detail-panel">
    <div class="detail-empty" id="detail-empty">Select an initiative to view details</div>
    <div id="detail-content" style="display:none;"></div>
  </div>
</div>

<!-- Progress bar -->
<div class="progress-bar-container" id="progress-container">
  <div class="progress-label" id="progress-label">Processing...</div>
  <div class="progress-bar"><div class="fill" id="progress-fill" style="width:0%"></div></div>
</div>

<!-- Import overlay -->
<div class="import-overlay hidden" id="import-overlay">
  <div class="import-box" id="import-box">
    <h2>Import Enrichment Data</h2>
    <p>Drag and drop your .xlsx file here, or click to browse</p>
    <button class="btn btn-primary" onclick="document.getElementById('file-input').click()">Choose File</button>
    <input type="file" id="file-input" accept=".xlsx">
    <p style="margin-top:16px;font-size:12px;color:var(--ink-faint)">Press Escape to cancel</p>
  </div>
</div>

<script>
// ---------------------------------------------------------------------------
// State
// ---------------------------------------------------------------------------
const state = {
  initiatives: [],
  selectedId: null,
  sort: { by: 'score', dir: 'desc' },
  loading: false,
  columnOrder: JSON.parse(localStorage.getItem('scout-col-order') || 'null') || [0,1,2,3,4,5,6],
};

// ---------------------------------------------------------------------------
// API helpers
// ---------------------------------------------------------------------------
async function api(method, path, body) {
  const opts = { method, headers: {} };
  if (body instanceof FormData) {
    opts.body = body;
  } else if (body) {
    opts.headers['Content-Type'] = 'application/json';
    opts.body = JSON.stringify(body);
  }
  const resp = await fetch(path, opts);
  if (!resp.ok) {
    const err = await resp.text();
    throw new Error(`${resp.status}: ${err}`);
  }
  return resp.json();
}

// ---------------------------------------------------------------------------
// Data loading
// ---------------------------------------------------------------------------
async function loadInitiatives() {
  const f = getFilters();
  let url = `/api/initiatives?sort_by=${state.sort.by}&sort_dir=${state.sort.dir}&per_page=500`;
  if (f.verdict) url += `&verdict=${encodeURIComponent(f.verdict)}`;
  if (f.classification) url += `&classification=${encodeURIComponent(f.classification)}`;
  if (f.uni) url += `&uni=${encodeURIComponent(f.uni)}`;
  if (f.search) url += `&search=${encodeURIComponent(f.search)}`;
  const data = await api('GET', url);
  state.initiatives = data.items;
  renderList();
  loadStats();
}

async function loadStats() {
  const stats = await api('GET', '/api/stats');
  document.getElementById('stat-total').textContent = stats.total;
  document.getElementById('stat-enriched').textContent = stats.enriched;
  document.getElementById('stat-scored').textContent = stats.scored;
  document.getElementById('stat-now').textContent = `${stats.by_verdict.reach_out_now || 0} reach out now`;
  document.getElementById('stat-soon').textContent = `${stats.by_verdict.reach_out_soon || 0} soon`;
  document.getElementById('stat-monitor').textContent = `${stats.by_verdict.monitor || 0} monitor`;
  document.getElementById('btn-enrich-all').disabled = stats.total === 0;
  document.getElementById('btn-score-all').disabled = stats.total === 0;
}

async function loadDetail(id) {
  const data = await api('GET', `/api/initiatives/${id}`);
  state.selectedId = id;
  renderDetail(data);
  // Highlight selected row
  document.querySelectorAll('.list-table tbody tr').forEach(tr => {
    tr.classList.toggle('selected', parseInt(tr.dataset.id) === id);
  });
}

// ---------------------------------------------------------------------------
// Filters & sort
// ---------------------------------------------------------------------------
function getFilters() {
  return {
    verdict: document.getElementById('filter-verdict').value,
    classification: document.getElementById('filter-class').value,
    uni: document.getElementById('filter-uni').value,
    search: document.getElementById('filter-search').value,
  };
}

let _filterTimeout;
function applyFilters() {
  clearTimeout(_filterTimeout);
  _filterTimeout = setTimeout(() => loadInitiatives(), 200);
}

function sortBy(field) {
  if (state.sort.by === field) {
    state.sort.dir = state.sort.dir === 'desc' ? 'asc' : 'desc';
  } else {
    state.sort.by = field;
    state.sort.dir = field === 'name' ? 'asc' : 'desc';
  }
  loadInitiatives();
}

// ---------------------------------------------------------------------------
// Column definitions & inline editing
// ---------------------------------------------------------------------------
function escAttr(s) { return esc(s || '').replace(/'/g, '&#39;'); }
function editAttr(id, field, value, type) {
  return ` data-edit-id="${id}" data-edit-field="${field}" data-edit-value="${escAttr(value)}"${type ? ` data-edit-type="${type}"` : ''}`;
}
function editFromAttr(el, e) {
  if (e) e.stopPropagation();
  inlineEdit(el, +el.dataset.editId, el.dataset.editField, el.dataset.editValue, el.dataset.editType);
}

const COLUMNS = [
  { key: 'name', label: 'Initiative', sort: 'name',
    render: i => `<td class="name-cell editable" title="${esc(i.name)}"${editAttr(i.id,'name',i.name)} ondblclick="editFromAttr(this,event)">${esc(i.name)}</td>` },
  { key: 'uni', label: 'Uni', sort: 'uni',
    render: i => `<td class="uni-cell editable"${editAttr(i.id,'uni',i.uni,'select-uni')} ondblclick="editFromAttr(this,event)">${esc(i.uni)}</td>` },
  { key: 'verdict', label: 'Verdict', sort: 'verdict',
    render: i => { const v = i.verdict || 'unscored'; return `<td><span class="verdict-badge verdict-${v}">${VERDICT_SHORT[v] || '\u2014'}</span></td>`; } },
  { key: 'team', label: 'Team', sort: 'grade_team',
    render: i => `<td>${gradeBadge(i.grade_team)}</td>` },
  { key: 'tech', label: 'Tech', sort: 'grade_tech',
    render: i => `<td>${gradeBadge(i.grade_tech)}</td>` },
  { key: 'opp', label: 'Opp', sort: 'grade_opportunity',
    render: i => `<td>${gradeBadge(i.grade_opportunity)}</td>` },
  { key: 'class', label: 'Class', sort: null,
    render: i => `<td><span class="class-badge">${esc((i.classification || '').replace(/_/g, ' '))}</span></td>` },
];

function inlineEdit(el, id, field, currentValue, type) {
  if (el.querySelector('.inline-input, .inline-select')) return;
  const original = el.innerHTML;
  let input;

  if (type === 'select-uni') {
    input = document.createElement('select');
    input.className = 'inline-select';
    ['TUM', 'LMU', 'HM', 'TUM/LMU', 'TUM/HM', 'LMU/HM'].forEach(opt => {
      const o = document.createElement('option');
      o.value = opt; o.textContent = opt;
      if (opt === currentValue) o.selected = true;
      input.appendChild(o);
    });
  } else if (type === 'textarea') {
    input = document.createElement('textarea');
    input.className = 'inline-input';
    input.value = currentValue || '';
    input.rows = 4;
  } else {
    input = document.createElement('input');
    input.className = 'inline-input';
    input.type = 'text';
    input.value = currentValue || '';
  }

  el.innerHTML = '';
  el.appendChild(input);
  input.focus();
  if (input.select) input.select();

  let done = false;
  async function save() {
    if (done) return;
    done = true;
    const newVal = input.value.trim();
    if (newVal === (currentValue || '').trim()) { el.innerHTML = original; return; }
    try {
      await api('PUT', `/api/initiatives/${id}`, { [field]: newVal });
      loadInitiatives();
      if (state.selectedId === id) loadDetail(id);
    } catch (err) {
      el.innerHTML = original;
      alert('Save failed: ' + err.message);
    }
  }
  function cancel() { done = true; el.innerHTML = original; }

  input.addEventListener('blur', save);
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter' && type !== 'textarea') { e.preventDefault(); save(); }
    if (e.key === 'Escape') { e.preventDefault(); cancel(); }
  });
}

// ---------------------------------------------------------------------------
// Column drag-and-drop
// ---------------------------------------------------------------------------
function initColumnDnD() {
  let dragIdx = null;
  document.querySelectorAll('#list-head th').forEach(th => {
    th.addEventListener('dragstart', e => {
      dragIdx = parseInt(th.dataset.colIdx);
      e.dataTransfer.effectAllowed = 'move';
      th.style.opacity = '0.4';
    });
    th.addEventListener('dragend', () => {
      th.style.opacity = '1';
      document.querySelectorAll('#list-head th').forEach(h => h.classList.remove('drag-over'));
    });
    th.addEventListener('dragover', e => {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      th.classList.add('drag-over');
    });
    th.addEventListener('dragleave', () => th.classList.remove('drag-over'));
    th.addEventListener('drop', e => {
      e.preventDefault();
      th.classList.remove('drag-over');
      const toIdx = parseInt(th.dataset.colIdx);
      if (dragIdx === toIdx) return;
      const order = [...state.columnOrder];
      const fromPos = order.indexOf(dragIdx);
      const toPos = order.indexOf(toIdx);
      order.splice(fromPos, 1);
      order.splice(toPos, 0, dragIdx);
      state.columnOrder = order;
      localStorage.setItem('scout-col-order', JSON.stringify(order));
      renderList();
    });
  });
}

// ---------------------------------------------------------------------------
// Render list
// ---------------------------------------------------------------------------
function renderList() {
  const tbody = document.getElementById('list-body');
  const thead = document.getElementById('list-head');
  const empty = document.getElementById('empty-state');

  if (state.initiatives.length === 0) {
    tbody.innerHTML = '';
    thead.innerHTML = '';
    empty.style.display = 'flex';
    return;
  }
  empty.style.display = 'none';

  // Render header from column order
  thead.innerHTML = state.columnOrder.map(idx => {
    const col = COLUMNS[idx];
    return `<th draggable="true" data-col-idx="${idx}" ${col.sort ? `onclick="sortBy('${col.sort}')"` : ''}>${col.label}</th>`;
  }).join('');

  // Render body
  tbody.innerHTML = state.initiatives.map(i => {
    const cells = state.columnOrder.map(idx => COLUMNS[idx].render(i)).join('');
    return `<tr data-id="${i.id}" onclick="loadDetail(${i.id})" class="${i.id === state.selectedId ? 'selected' : ''}">${cells}</tr>`;
  }).join('');

  initColumnDnD();
}

// ---------------------------------------------------------------------------
// Render detail
// ---------------------------------------------------------------------------
function renderDetail(d) {
  document.getElementById('detail-empty').style.display = 'none';
  const el = document.getElementById('detail-content');
  el.style.display = 'block';

  const v = d.verdict || 'unscored';
  const vLabel = VERDICT_LONG[v] || 'Not Scored';

  const ea = (f,v,t) => editAttr(d.id,f,v,t);
  let html = `
    <div class="detail-header">
      <h2 class="editable"${ea('name',d.name)} ondblclick="editFromAttr(this)">${esc(d.name)}</h2>
      <div class="meta">
        <span class="editable"${ea('uni',d.uni,'select-uni')} ondblclick="editFromAttr(this)">${esc(d.uni)}</span>
        <span class="editable"${ea('sector',d.sector)} ondblclick="editFromAttr(this)">${esc(d.sector) || 'Sector'}</span>
        <span class="editable"${ea('mode',d.mode)} ondblclick="editFromAttr(this)">${esc(d.mode) || 'Mode'}</span>
        <span class="editable"${ea('relevance',d.relevance)} ondblclick="editFromAttr(this)">Rating: ${esc(d.relevance) || '—'}</span>
        ${d.enriched ? `<span>Enriched</span>` : '<span style="color:var(--amber)">Not enriched</span>'}
      </div>
    </div>`;

  // Verdict card
  if (d.verdict) {
    html += `
    <div class="detail-verdict ${v}">
      <div class="verdict-label">${vLabel} — ${d.score?.toFixed(1) || '?'}/5 — ${esc(d.classification?.replace(/_/g, ' ') || '')}</div>
      <div class="reasoning">${esc(d.reasoning || '')}</div>
    </div>`;
  }

  // Dimension grades
  if (d.grade_team || d.grade_tech || d.grade_opportunity) {
    html += `<div class="grade-cards">${[['grade_team','Team'],['grade_tech','Tech'],['grade_opportunity','Opportunity']].map(
      ([k,l]) => `<div class="grade-card"><div class="grade-value ${gradeColorClass(d[k])}">${esc(d[k]||'—')}</div><div class="grade-label">${l}</div></div>`
    ).join('')}</div>`;
  }

  // Contact
  if (d.contact_who) {
    html += `
    <div class="contact-card">
      <div class="label">Contact</div>
      <div class="value">${esc(d.contact_who)}</div>
    </div>`;
  }

  // Engagement hook
  if (d.engagement_hook) {
    html += `<div class="hook-card">${esc(d.engagement_hook)}</div>`;
  }

  html += listSection('Key Evidence', d.key_evidence);
  html += listSection('Data Gaps', d.data_gaps);

  // Description
  html += `<div class="detail-section"><h3>Description</h3><p class="editable"${ea('description',d.description,'textarea')} ondblclick="editFromAttr(this)">${esc(d.description) || 'Double-click to add description...'}</p></div>`;

  // Domain tags
  const hasDomains = d.technology_domains || d.market_domains || d.categories;
  if (hasDomains) {
    html += `<div class="detail-section"><h3>Domains</h3><div>`;
    if (d.technology_domains) {
      d.technology_domains.split(';').map(s => s.trim()).filter(Boolean).forEach(t => {
        html += `<span class="domain-pill tech">${esc(t.replace(/_/g, ' '))}</span>`;
      });
    }
    if (d.market_domains) {
      d.market_domains.split(';').map(s => s.trim()).filter(Boolean).forEach(m => {
        html += `<span class="domain-pill market">${esc(m.replace(/_/g, ' '))}</span>`;
      });
    }
    if (d.categories) {
      html += `<span class="domain-pill cat">${esc(d.categories)}</span>`;
    }
    html += `</div></div>`;
  }

  // Pre-computed scores
  if (d.outreach_now_score || d.venture_upside_score) {
    html += `<div class="detail-section"><h3>Pipeline Scores</h3>`;
    if (d.outreach_now_score != null) {
      const pct = Math.min(d.outreach_now_score / 5 * 100, 100);
      html += `<div class="score-bar-row"><span class="score-bar-label">Outreach</span><div class="score-bar"><div class="bar-fill green" style="width:${pct}%"></div></div><span class="score-bar-val">${d.outreach_now_score.toFixed(1)}</span></div>`;
    }
    if (d.venture_upside_score != null) {
      const pct = Math.min(d.venture_upside_score / 5 * 100, 100);
      html += `<div class="score-bar-row"><span class="score-bar-label">Venture Upside</span><div class="score-bar"><div class="bar-fill blue" style="width:${pct}%"></div></div><span class="score-bar-val">${d.venture_upside_score.toFixed(1)}</span></div>`;
    }
    html += `</div>`;
  }

  // Signal cards
  const signalsHtml = SIGNALS.map(([k,l]) => signalCard(d[k], l)).join('');
  if (signalsHtml) html += `<div class="detail-section"><h3>Signals</h3><div class="signal-grid">${signalsHtml}</div></div>`;

  // Due diligence
  if (d.dd_is_investable || d.dd_key_roles || d.dd_references_count) {
    html += `<div class="detail-section"><h3>Due Diligence</h3><ul>`;
    if (d.dd_is_investable) html += `<li style="color:var(--green)">Investable</li>`;
    if (d.dd_references_count) html += `<li>References: ${d.dd_references_count}</li>`;
    if (d.dd_key_roles) html += `<li>Key roles: ${esc(d.dd_key_roles.replace(/_/g, ' '))}</li>`;
    if (d.member_roles) html += `<li>Member roles: ${esc(d.member_roles.replace(/_/g, ' '))}</li>`;
    html += `</ul></div>`;
  }

  // Links (with edit pencils)
  const LINK_FIELDS = [['Website','website',d.website,d.website],['Email','email',d.email,'mailto:'+d.email],['LinkedIn','linkedin',d.linkedin,d.linkedin],['GitHub','github_org',d.github_org,'https://github.com/'+d.github_org],['Team','team_page',d.team_page,d.team_page]];
  html += `<div class="detail-section"><h3>Links</h3><div class="link-row">`;
  LINK_FIELDS.forEach(([label, field, raw, url]) => {
    if (raw) {
      html += `<a href="${esc(safeUrl(url))}" target="_blank" class="link-pill">${esc(label)}</a>`;
      html += `<span class="edit-pencil"${editAttr(d.id, field, raw)} onclick="editFromAttr(this)">&#9998;</span>`;
    } else {
      html += `<span class="link-pill editable" style="color:var(--ink-faint);cursor:pointer"${editAttr(d.id, field, '')} ondblclick="editFromAttr(this)">+ ${label}</span>`;
    }
  });
  html += `</div></div>`;

  // Extra info (editable)
  html += `<div class="detail-section"><h3>Additional Info</h3><ul>`;
  [['team_size','Team size'],['key_repos','Key repos'],['sponsors','Sponsors'],['competitions','Competitions']].forEach(([f,l]) => {
    html += `<li class="editable"${ea(f,d[f])} ondblclick="editFromAttr(this)">${l}: ${esc(d[f]) || '—'}</li>`;
  });
  html += `</ul></div>`;

  // Enrichments
  if (d.enrichments && d.enrichments.length > 0) {
    html += `<div class="detail-section"><h3>Enrichment Sources</h3><ul>`;
    d.enrichments.forEach(e => {
      html += `<li>${esc(e.source_type)} — ${esc(e.fetched_at.split('T')[0])}</li>`;
    });
    html += `</ul></div>`;
  }

  // Projects
  html += `<div class="detail-section"><h3>Projects</h3>`;
  html += `<div id="project-form-slot"></div>`;
  if (d.projects && d.projects.length > 0) {
    d.projects.forEach(p => {
      const pv = p.verdict || 'unscored';
      const pvLabel = VERDICT_SHORT[pv] || '';
      html += `<div class="project-card" id="project-${p.id}">`;
      html += `<div class="project-card-header">`;
      html += `<h4>${esc(p.name)} ${pvLabel ? `<span class="verdict-badge verdict-${pv}" style="margin-left:6px;font-size:10px">${pvLabel}</span>` : ''}</h4>`;
      html += `<div class="project-card-actions">`;
      html += `<button class="btn btn-sm" onclick="scoreProject(${p.id})" title="Score">Score</button>`;
      html += `<button class="btn btn-sm" onclick="showProjectForm(${d.id}, ${p.id})" title="Edit">Edit</button>`;
      html += `<button class="btn btn-sm" onclick="deleteProject(${p.id}, ${d.id})" title="Delete" style="color:var(--red)">Del</button>`;
      html += `</div></div>`;
      // Meta info
      const meta = [];
      if (p.description) meta.push(p.description);
      if (p.team) meta.push(`Team: ${p.team}`);
      if (meta.length > 0) html += `<div class="project-meta">${esc(meta.join(' — '))}</div>`;
      // Links
      const pLinks = [];
      if (p.website) pLinks.push(`<a href="${esc(safeUrl(p.website))}" target="_blank" class="link-pill">Website</a>`);
      if (p.github_url) pLinks.push(`<a href="${esc(safeUrl(p.github_url))}" target="_blank" class="link-pill">GitHub</a>`);
      if (p.extra_links) {
        Object.entries(p.extra_links).forEach(([k, v]) => {
          if (v) pLinks.push(`<a href="${esc(safeUrl(v))}" target="_blank" class="link-pill">${esc(k)}</a>`);
        });
      }
      if (pLinks.length > 0) html += `<div class="link-row">${pLinks.join('')}</div>`;
      // Grades
      if (p.grade_team || p.grade_tech || p.grade_opportunity) {
        html += `<div class="project-grades">`;
        html += `<span class="pg-item">Team ${gradeBadge(p.grade_team)}</span>`;
        html += `<span class="pg-item">Tech ${gradeBadge(p.grade_tech)}</span>`;
        html += `<span class="pg-item">Opp ${gradeBadge(p.grade_opportunity)}</span>`;
        html += `</div>`;
      }
      html += `</div>`;
    });
  } else {
    html += `<p style="color:var(--ink-faint);font-size:13px">No projects yet</p>`;
  }
  html += `<button class="btn btn-sm" style="margin-top:8px" onclick="showProjectForm(${d.id})">+ Add Project</button>`;
  html += `</div>`;

  // Actions
  html += `
    <div class="detail-actions">
      <button class="btn btn-sm" onclick="enrichOne(${d.id})">Enrich</button>
      <button class="btn btn-sm btn-primary" onclick="scoreOne(${d.id})">Score</button>
    </div>`;

  el.innerHTML = html;
}

// ---------------------------------------------------------------------------
// Import
// ---------------------------------------------------------------------------
function showImport() {
  document.getElementById('import-overlay').classList.remove('hidden');
}
function hideImport() {
  document.getElementById('import-overlay').classList.add('hidden');
}

document.getElementById('import-overlay').addEventListener('click', e => {
  if (e.target === document.getElementById('import-overlay')) hideImport();
});
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') hideImport();
});

// Drag and drop
const importBox = document.getElementById('import-box');
importBox.addEventListener('dragover', e => { e.preventDefault(); importBox.classList.add('dragover'); });
importBox.addEventListener('dragleave', () => importBox.classList.remove('dragover'));
importBox.addEventListener('drop', e => {
  e.preventDefault();
  importBox.classList.remove('dragover');
  const file = e.dataTransfer.files[0];
  if (file) uploadFile(file);
});

document.getElementById('file-input').addEventListener('change', e => {
  const file = e.target.files[0];
  if (file) uploadFile(file);
});

async function uploadFile(file) {
  if (!file.name.endsWith('.xlsx')) {
    alert('Please select an .xlsx file');
    return;
  }
  const fd = new FormData();
  fd.append('file', file);
  try {
    const result = await api('POST', '/api/import', fd);
    hideImport();
    alert(`Imported ${result.total_imported} initiatives (${result.spin_off_count} spin-off targets, ${result.all_initiatives_count} all initiatives, ${result.duplicates_updated} updated)`);
    loadInitiatives();
  } catch (err) {
    alert('Import failed: ' + err.message);
  }
}

// ---------------------------------------------------------------------------
// Enrich & Score (single)
// ---------------------------------------------------------------------------
async function enrichOne(id) {
  try {
    const r = await api('POST', `/api/enrich/${id}`);
    alert(`Added ${r.enrichments_added} enrichments`);
    loadDetail(id);
    loadStats();
  } catch (err) {
    alert('Enrich failed: ' + err.message);
  }
}

async function scoreOne(id) {
  try {
    const r = await api('POST', `/api/score/${id}`);
    alert(`Verdict: ${r.verdict} (${r.score})`);
    loadDetail(id);
    loadInitiatives();
  } catch (err) {
    alert('Score failed: ' + err.message);
  }
}

// ---------------------------------------------------------------------------
// Batch operations via SSE (streaming fetch)
// ---------------------------------------------------------------------------
async function streamBatch(url, body) {
  const container = document.getElementById('progress-container');
  const label = document.getElementById('progress-label');
  const fill = document.getElementById('progress-fill');
  container.classList.add('active');
  fill.style.width = '0%';

  try {
    const resp = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body || {}),
    });

    const reader = resp.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      buffer += decoder.decode(value, { stream: true });

      const lines = buffer.split('\n');
      buffer = lines.pop() || '';

      for (const line of lines) {
        if (!line.startsWith('data: ')) continue;
        try {
          const event = JSON.parse(line.slice(6));
          if (event.type === 'progress') {
            const pct = Math.round((event.current / event.total) * 100);
            fill.style.width = pct + '%';
            label.textContent = `${event.current}/${event.total} — ${event.name}`;
          } else if (event.type === 'complete') {
            label.textContent = `Done! ${JSON.stringify(event.stats)}`;
            setTimeout(() => container.classList.remove('active'), 3000);
            loadInitiatives();
          }
        } catch {}
      }
    }
  } catch (err) {
    label.textContent = `Error: ${err.message}`;
    setTimeout(() => container.classList.remove('active'), 5000);
  }
}

function enrichBatch() { streamBatch('/api/enrich/batch', null); }
function scoreBatch() { streamBatch('/api/score/batch', null); }

// ---------------------------------------------------------------------------
// Keyboard navigation
// ---------------------------------------------------------------------------
document.addEventListener('keydown', e => {
  if (['INPUT', 'SELECT', 'TEXTAREA'].includes(document.activeElement.tagName)) return;
  if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
    e.preventDefault();
    const items = state.initiatives;
    if (items.length === 0) return;
    const idx = items.findIndex(i => i.id === state.selectedId);
    let next;
    if (e.key === 'ArrowDown') next = Math.min(idx + 1, items.length - 1);
    else next = Math.max(idx - 1, 0);
    if (next >= 0 && next < items.length) {
      loadDetail(items[next].id);
      // Scroll into view
      const row = document.querySelector(`tr[data-id="${items[next].id}"]`);
      if (row) row.scrollIntoView({ block: 'nearest' });
    }
  }
});

// ---------------------------------------------------------------------------
// Utility
// ---------------------------------------------------------------------------
function esc(s) {
  if (!s) return '';
  const div = document.createElement('div');
  div.textContent = String(s);
  return div.innerHTML;
}

function safeUrl(url) {
  if (!url) return '#';
  const s = String(url).trim();
  if (/^(javascript|data|vbscript):/i.test(s)) return '#';
  return s;
}

function gradeColorClass(grade) {
  if (!grade) return '';
  const c = grade.charAt(0).toUpperCase();
  if (c === 'A') return 'grade-a';
  if (c === 'B') return 'grade-b';
  if (c === 'C') return 'grade-c';
  return 'grade-d';
}

function gradeBadge(grade) {
  if (!grade) return '<span style="color:var(--ink-faint)">—</span>';
  return `<span class="grade-badge ${gradeColorClass(grade)}">${esc(grade)}</span>`;
}

const VERDICT_SHORT = { reach_out_now: 'NOW', reach_out_soon: 'SOON', monitor: 'MON', skip: 'SKIP' };
const VERDICT_LONG = { reach_out_now: 'Reach Out Now', reach_out_soon: 'Reach Out Soon', monitor: 'Monitor', skip: 'Skip' };

function signalCard(value, label) {
  return value ? `<div class="signal-card"><div class="signal-value">${value}</div><div class="signal-label">${esc(label)}</div></div>` : '';
}

function listSection(title, items) {
  if (!items?.length) return '';
  return `<div class="detail-section"><h3>${title}</h3><ul>${items.map(i => `<li>${esc(i)}</li>`).join('')}</ul></div>`;
}

const SIGNALS = [
  ['member_count','Members'],['github_repo_count','Repos'],['github_contributors','Contributors'],
  ['github_commits_90d','Commits (90d)'],['huggingface_model_hits','HF Models'],['openalex_hits','OpenAlex'],
  ['semantic_scholar_hits','Semantic Scholar'],['linkedin_hits','LinkedIn'],['researchgate_hits','ResearchGate'],
];

// ---------------------------------------------------------------------------
// Projects
// ---------------------------------------------------------------------------
async function showProjectForm(initiativeId, projectId) {
  const slot = document.getElementById('project-form-slot');
  if (!slot) return;

  let p = { name: '', description: '', website: '', github_url: '', team: '' };
  if (projectId) {
    // Fetch existing project data from the detail already loaded
    const detail = await api('GET', `/api/initiatives/${initiativeId}`);
    const found = (detail.projects || []).find(x => x.id === projectId);
    if (found) p = found;
  }

  slot.innerHTML = `
    <div class="project-form">
      <div class="pf-row"><label>Name *</label><input id="pf-name" value="${esc(p.name)}"></div>
      <div class="pf-row"><label>Description</label><textarea id="pf-desc">${esc(p.description)}</textarea></div>
      <div class="pf-row"><label>Website</label><input id="pf-website" value="${esc(p.website)}"></div>
      <div class="pf-row"><label>GitHub URL</label><input id="pf-github" value="${esc(p.github_url)}"></div>
      <div class="pf-row"><label>Team</label><input id="pf-team" value="${esc(p.team)}"></div>
      <div class="pf-actions">
        <button class="btn btn-sm btn-primary" onclick="submitProject(${initiativeId}, ${projectId || 'null'})">${projectId ? 'Update' : 'Create'}</button>
        <button class="btn btn-sm" onclick="document.getElementById('project-form-slot').innerHTML=''">Cancel</button>
      </div>
    </div>`;
  slot.querySelector('#pf-name').focus();
}

async function submitProject(initiativeId, projectId) {
  const name = document.getElementById('pf-name').value.trim();
  if (!name) { alert('Name is required'); return; }

  const body = {
    name,
    description: document.getElementById('pf-desc').value.trim(),
    website: document.getElementById('pf-website').value.trim(),
    github_url: document.getElementById('pf-github').value.trim(),
    team: document.getElementById('pf-team').value.trim(),
  };

  try {
    if (projectId) {
      await api('PUT', `/api/projects/${projectId}`, body);
    } else {
      await api('POST', `/api/initiatives/${initiativeId}/projects`, body);
    }
    loadDetail(initiativeId);
  } catch (err) {
    alert('Failed: ' + err.message);
  }
}

async function deleteProject(projectId, initiativeId) {
  if (!confirm('Delete this project and its scores?')) return;
  try {
    await api('DELETE', `/api/projects/${projectId}`);
    loadDetail(initiativeId);
  } catch (err) {
    alert('Delete failed: ' + err.message);
  }
}

async function scoreProject(projectId) {
  try {
    const r = await api('POST', `/api/projects/${projectId}/score`);
    alert(`Project verdict: ${r.verdict} (${r.score})`);
    if (state.selectedId) loadDetail(state.selectedId);
  } catch (err) {
    alert('Score failed: ' + err.message);
  }
}

// ---------------------------------------------------------------------------
// Init
// ---------------------------------------------------------------------------
loadInitiatives();
</script>
</body>
</html>
