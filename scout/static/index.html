<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Scout — Outreach Intelligence</title>
<style>
:root {
  --bg: #0f1117;
  --surface: #1a1d27;
  --surface-2: #242836;
  --border: #2e3345;
  --ink: #e4e7ef;
  --ink-dim: #8b90a0;
  --ink-faint: #555a6e;
  --green: #22c55e;
  --green-bg: #0a2a1a;
  --blue: #3b82f6;
  --blue-bg: #0c1a3a;
  --amber: #f59e0b;
  --amber-bg: #2a1f08;
  --gray: #6b7280;
  --gray-bg: #1a1d22;
  --red: #ef4444;
  --accent: #8b5cf6;
  --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  --mono: 'SF Mono', 'Fira Code', monospace;
  --radius: 8px;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: var(--font); background: var(--bg); color: var(--ink); font-size: 14px; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
a { color: var(--blue); text-decoration: none; }

/* --- Header --- */
.header { display: flex; align-items: center; justify-content: space-between; padding: 12px 20px; border-bottom: 1px solid var(--border); background: var(--surface); }
.header h1 { font-size: 18px; font-weight: 600; letter-spacing: -0.5px; }
.header-actions { display: flex; gap: 8px; }

/* --- Stats bar --- */
.stats-bar { display: flex; gap: 16px; padding: 10px 20px; border-bottom: 1px solid var(--border); background: var(--surface); font-size: 13px; }
.stat { display: flex; align-items: center; gap: 6px; color: var(--ink-dim); }
.stat strong { color: var(--ink); font-variant-numeric: tabular-nums; }

/* --- Filters --- */
.filters { display: flex; gap: 8px; padding: 10px 20px; border-bottom: 1px solid var(--border); background: var(--surface); flex-wrap: wrap; align-items: center; }
.filter-select, .search-input { background: var(--surface-2); border: 1px solid var(--border); color: var(--ink); padding: 6px 10px; border-radius: var(--radius); font-size: 13px; outline: none; }
.filter-select:focus, .search-input:focus { border-color: var(--accent); }
.search-input { width: 200px; }

/* --- Main layout --- */
.main { display: flex; flex: 1; overflow: hidden; }

/* --- List panel --- */
.list-panel { flex: 0 0 55%; overflow-y: auto; border-right: 1px solid var(--border); }
.list-table { width: 100%; border-collapse: collapse; }
.list-table th { position: sticky; top: 0; background: var(--surface); padding: 10px 12px; text-align: left; font-size: 12px; font-weight: 500; color: var(--ink-dim); text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid var(--border); cursor: pointer; user-select: none; }
.list-table th:hover { color: var(--ink); }
.list-table td { padding: 10px 12px; border-bottom: 1px solid var(--border); vertical-align: middle; }
.list-table tr { cursor: pointer; transition: background 0.1s; }
.list-table tbody tr:hover { background: var(--surface-2); }
.list-table tbody tr.selected { background: var(--surface-2); border-left: 3px solid var(--accent); }
.list-table .name-cell { font-weight: 500; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.list-table .uni-cell { font-size: 12px; color: var(--ink-dim); }
.list-table .sector-cell { font-size: 12px; color: var(--ink-dim); max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.list-table .score-cell { font-variant-numeric: tabular-nums; font-weight: 600; }

/* Verdict badges */
.verdict-badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
.verdict-reach_out_now { background: var(--green-bg); color: var(--green); }
.verdict-reach_out_soon { background: var(--blue-bg); color: var(--blue); }
.verdict-monitor { background: var(--amber-bg); color: var(--amber); }
.verdict-skip { background: var(--gray-bg); color: var(--gray); }
.verdict-unscored { background: var(--surface-2); color: var(--ink-faint); }

/* Classification badges */
.class-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 11px; color: var(--ink-dim); background: var(--surface-2); }

/* --- Detail panel --- */
.detail-panel { flex: 1; overflow-y: auto; padding: 20px; }
.detail-empty { display: flex; align-items: center; justify-content: center; height: 100%; color: var(--ink-faint); font-size: 15px; }
.detail-header { margin-bottom: 20px; }
.detail-header h2 { font-size: 20px; font-weight: 600; margin-bottom: 4px; }
.detail-header .meta { font-size: 13px; color: var(--ink-dim); display: flex; gap: 12px; flex-wrap: wrap; }
.detail-section { margin-bottom: 20px; }
.detail-section h3 { font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--ink-dim); margin-bottom: 8px; }
.detail-section p, .detail-section li { font-size: 14px; line-height: 1.6; }
.detail-section ul { padding-left: 18px; }
.detail-section li { margin-bottom: 4px; }
.detail-verdict { padding: 16px; border-radius: var(--radius); margin-bottom: 16px; }
.detail-verdict.reach_out_now { background: var(--green-bg); border: 1px solid #1a5c35; }
.detail-verdict.reach_out_soon { background: var(--blue-bg); border: 1px solid #1a3a6e; }
.detail-verdict.monitor { background: var(--amber-bg); border: 1px solid #5c4a1a; }
.detail-verdict.skip { background: var(--gray-bg); border: 1px solid #3a3d44; }
.detail-verdict .verdict-label { font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
.detail-verdict .reasoning { font-size: 14px; line-height: 1.5; }

.contact-card { background: var(--surface-2); border: 1px solid var(--border); border-radius: var(--radius); padding: 14px; margin-bottom: 16px; }
.contact-card .label { font-size: 11px; font-weight: 600; text-transform: uppercase; color: var(--ink-dim); margin-bottom: 4px; }
.contact-card .value { font-size: 14px; }

.hook-card { background: var(--surface-2); border-left: 3px solid var(--accent); border-radius: 0 var(--radius) var(--radius) 0; padding: 14px; margin-bottom: 16px; font-style: italic; line-height: 1.5; }

.detail-actions { display: flex; gap: 8px; margin-top: 16px; }

/* --- Buttons --- */
.btn { padding: 7px 14px; border-radius: var(--radius); border: 1px solid var(--border); background: var(--surface-2); color: var(--ink); cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.15s; }
.btn:hover { background: var(--border); }
.btn:disabled { opacity: 0.5; cursor: not-allowed; }
.btn-primary { background: var(--accent); border-color: var(--accent); color: white; }
.btn-primary:hover { opacity: 0.9; }
.btn-sm { padding: 5px 10px; font-size: 12px; }

/* --- Progress bar --- */
.progress-bar-container { padding: 10px 20px; border-top: 1px solid var(--border); background: var(--surface); display: none; }
.progress-bar-container.active { display: flex; align-items: center; gap: 12px; }
.progress-bar { flex: 1; height: 6px; background: var(--surface-2); border-radius: 3px; overflow: hidden; }
.progress-bar .fill { height: 100%; background: var(--accent); transition: width 0.2s; border-radius: 3px; }
.progress-label { font-size: 12px; color: var(--ink-dim); white-space: nowrap; min-width: 180px; }

/* --- Import overlay --- */
.import-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 100; }
.import-overlay.hidden { display: none; }
.import-box { background: var(--surface); border: 2px dashed var(--border); border-radius: 16px; padding: 60px; text-align: center; max-width: 500px; }
.import-box.dragover { border-color: var(--accent); background: var(--surface-2); }
.import-box h2 { font-size: 20px; margin-bottom: 8px; }
.import-box p { color: var(--ink-dim); margin-bottom: 20px; }
.import-box input[type="file"] { display: none; }

/* --- Empty state --- */
.empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--ink-dim); gap: 12px; padding: 40px; text-align: center; }
.empty-state h2 { font-size: 18px; color: var(--ink); }

/* --- Links --- */
.link-row { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
.link-pill { font-size: 11px; padding: 2px 8px; border-radius: 10px; background: var(--surface-2); color: var(--blue); border: 1px solid var(--border); }
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <h1>Scout</h1>
  <div class="header-actions">
    <button class="btn btn-sm" onclick="showImport()">Import XLSX</button>
    <button class="btn btn-sm" id="btn-enrich-all" onclick="enrichBatch()" disabled>Enrich All</button>
    <button class="btn btn-sm" id="btn-score-all" onclick="scoreBatch()" disabled>Score All</button>
  </div>
</div>

<!-- Stats -->
<div class="stats-bar" id="stats-bar">
  <div class="stat"><strong id="stat-total">0</strong> total</div>
  <div class="stat"><strong id="stat-enriched">0</strong> enriched</div>
  <div class="stat"><strong id="stat-scored">0</strong> scored</div>
  <div class="stat"><span class="verdict-badge verdict-reach_out_now" id="stat-now">0 reach out now</span></div>
  <div class="stat"><span class="verdict-badge verdict-reach_out_soon" id="stat-soon">0 soon</span></div>
  <div class="stat"><span class="verdict-badge verdict-monitor" id="stat-monitor">0 monitor</span></div>
</div>

<!-- Filters -->
<div class="filters">
  <select class="filter-select" id="filter-verdict" onchange="applyFilters()">
    <option value="">All Verdicts</option>
    <option value="reach_out_now">Reach Out Now</option>
    <option value="reach_out_soon">Reach Out Soon</option>
    <option value="monitor">Monitor</option>
    <option value="skip">Skip</option>
    <option value="unscored">Unscored</option>
  </select>
  <select class="filter-select" id="filter-class" onchange="applyFilters()">
    <option value="">All Types</option>
    <option value="deep_tech">Deep Tech</option>
    <option value="student_venture">Student Venture</option>
    <option value="applied_research">Applied Research</option>
    <option value="student_club">Student Club</option>
    <option value="dormant">Dormant</option>
  </select>
  <select class="filter-select" id="filter-uni" onchange="applyFilters()">
    <option value="">All Unis</option>
    <option value="TUM">TUM</option>
    <option value="LMU">LMU</option>
    <option value="HM">HM</option>
  </select>
  <input class="search-input" id="filter-search" type="text" placeholder="Search..." oninput="applyFilters()">
</div>

<!-- Main layout -->
<div class="main">
  <!-- List -->
  <div class="list-panel" id="list-panel">
    <table class="list-table">
      <thead>
        <tr>
          <th onclick="sortBy('name')">Initiative</th>
          <th onclick="sortBy('uni')">Uni</th>
          <th onclick="sortBy('sector')">Sector</th>
          <th onclick="sortBy('verdict')">Verdict</th>
          <th onclick="sortBy('score')">Score</th>
          <th>Class</th>
        </tr>
      </thead>
      <tbody id="list-body"></tbody>
    </table>
    <div class="empty-state" id="empty-state" style="display:none;">
      <h2>No initiatives loaded</h2>
      <p>Import an XLSX spreadsheet to get started</p>
      <button class="btn btn-primary" onclick="showImport()">Import XLSX</button>
    </div>
  </div>

  <!-- Detail -->
  <div class="detail-panel" id="detail-panel">
    <div class="detail-empty" id="detail-empty">Select an initiative to view details</div>
    <div id="detail-content" style="display:none;"></div>
  </div>
</div>

<!-- Progress bar -->
<div class="progress-bar-container" id="progress-container">
  <div class="progress-label" id="progress-label">Processing...</div>
  <div class="progress-bar"><div class="fill" id="progress-fill" style="width:0%"></div></div>
</div>

<!-- Import overlay -->
<div class="import-overlay hidden" id="import-overlay">
  <div class="import-box" id="import-box">
    <h2>Import Enrichment Data</h2>
    <p>Drag and drop your .xlsx file here, or click to browse</p>
    <button class="btn btn-primary" onclick="document.getElementById('file-input').click()">Choose File</button>
    <input type="file" id="file-input" accept=".xlsx">
    <p style="margin-top:16px;font-size:12px;color:var(--ink-faint)">Press Escape to cancel</p>
  </div>
</div>

<script>
// ---------------------------------------------------------------------------
// State
// ---------------------------------------------------------------------------
const state = {
  initiatives: [],
  selectedId: null,
  sort: { by: 'score', dir: 'desc' },
  loading: false,
};

// ---------------------------------------------------------------------------
// API helpers
// ---------------------------------------------------------------------------
async function api(method, path, body) {
  const opts = { method, headers: {} };
  if (body instanceof FormData) {
    opts.body = body;
  } else if (body) {
    opts.headers['Content-Type'] = 'application/json';
    opts.body = JSON.stringify(body);
  }
  const resp = await fetch(path, opts);
  if (!resp.ok) {
    const err = await resp.text();
    throw new Error(`${resp.status}: ${err}`);
  }
  return resp.json();
}

// ---------------------------------------------------------------------------
// Data loading
// ---------------------------------------------------------------------------
async function loadInitiatives() {
  const f = getFilters();
  let url = `/api/initiatives?sort_by=${state.sort.by}&sort_dir=${state.sort.dir}&per_page=500`;
  if (f.verdict) url += `&verdict=${f.verdict}`;
  if (f.classification) url += `&classification=${f.classification}`;
  if (f.uni) url += `&uni=${f.uni}`;
  if (f.search) url += `&search=${encodeURIComponent(f.search)}`;
  const data = await api('GET', url);
  state.initiatives = data.items;
  renderList();
  loadStats();
}

async function loadStats() {
  const stats = await api('GET', '/api/stats');
  document.getElementById('stat-total').textContent = stats.total;
  document.getElementById('stat-enriched').textContent = stats.enriched;
  document.getElementById('stat-scored').textContent = stats.scored;
  document.getElementById('stat-now').textContent = `${stats.by_verdict.reach_out_now || 0} reach out now`;
  document.getElementById('stat-soon').textContent = `${stats.by_verdict.reach_out_soon || 0} soon`;
  document.getElementById('stat-monitor').textContent = `${stats.by_verdict.monitor || 0} monitor`;
  document.getElementById('btn-enrich-all').disabled = stats.total === 0;
  document.getElementById('btn-score-all').disabled = stats.total === 0;
}

async function loadDetail(id) {
  const data = await api('GET', `/api/initiatives/${id}`);
  state.selectedId = id;
  renderDetail(data);
  // Highlight selected row
  document.querySelectorAll('.list-table tbody tr').forEach(tr => {
    tr.classList.toggle('selected', parseInt(tr.dataset.id) === id);
  });
}

// ---------------------------------------------------------------------------
// Filters & sort
// ---------------------------------------------------------------------------
function getFilters() {
  return {
    verdict: document.getElementById('filter-verdict').value,
    classification: document.getElementById('filter-class').value,
    uni: document.getElementById('filter-uni').value,
    search: document.getElementById('filter-search').value,
  };
}

let _filterTimeout;
function applyFilters() {
  clearTimeout(_filterTimeout);
  _filterTimeout = setTimeout(() => loadInitiatives(), 200);
}

function sortBy(field) {
  if (state.sort.by === field) {
    state.sort.dir = state.sort.dir === 'desc' ? 'asc' : 'desc';
  } else {
    state.sort.by = field;
    state.sort.dir = field === 'name' ? 'asc' : 'desc';
  }
  loadInitiatives();
}

// ---------------------------------------------------------------------------
// Render list
// ---------------------------------------------------------------------------
function renderList() {
  const tbody = document.getElementById('list-body');
  const empty = document.getElementById('empty-state');

  if (state.initiatives.length === 0) {
    tbody.innerHTML = '';
    empty.style.display = 'flex';
    return;
  }
  empty.style.display = 'none';

  tbody.innerHTML = state.initiatives.map(i => {
    const v = i.verdict || 'unscored';
    const vLabel = v === 'reach_out_now' ? 'NOW' :
                   v === 'reach_out_soon' ? 'SOON' :
                   v === 'monitor' ? 'MON' :
                   v === 'skip' ? 'SKIP' : '—';
    const score = i.score != null ? i.score.toFixed(1) : '—';
    const cls = i.classification || '';
    const clsLabel = cls.replace(/_/g, ' ');
    return `<tr data-id="${i.id}" onclick="loadDetail(${i.id})" class="${i.id === state.selectedId ? 'selected' : ''}">
      <td class="name-cell" title="${esc(i.name)}">${esc(i.name)}</td>
      <td class="uni-cell">${esc(i.uni)}</td>
      <td class="sector-cell" title="${esc(i.sector)}">${esc(i.sector)}</td>
      <td><span class="verdict-badge verdict-${v}">${vLabel}</span></td>
      <td class="score-cell">${score}</td>
      <td><span class="class-badge">${esc(clsLabel)}</span></td>
    </tr>`;
  }).join('');
}

// ---------------------------------------------------------------------------
// Render detail
// ---------------------------------------------------------------------------
function renderDetail(d) {
  document.getElementById('detail-empty').style.display = 'none';
  const el = document.getElementById('detail-content');
  el.style.display = 'block';

  const v = d.verdict || 'unscored';
  const vLabel = {
    reach_out_now: 'Reach Out Now',
    reach_out_soon: 'Reach Out Soon',
    monitor: 'Monitor',
    skip: 'Skip',
  }[v] || 'Not Scored';

  let html = `
    <div class="detail-header">
      <h2>${esc(d.name)}</h2>
      <div class="meta">
        <span>${esc(d.uni)}</span>
        <span>${esc(d.sector)}</span>
        <span>${esc(d.mode)}</span>
        ${d.relevance ? `<span>Rating: ${esc(d.relevance)}</span>` : ''}
        ${d.enriched ? `<span>Enriched</span>` : '<span style="color:var(--amber)">Not enriched</span>'}
      </div>
    </div>`;

  // Verdict card
  if (d.verdict) {
    html += `
    <div class="detail-verdict ${v}">
      <div class="verdict-label">${vLabel} — ${d.score?.toFixed(1) || '?'}/5 — ${esc(d.classification?.replace(/_/g, ' ') || '')}</div>
      <div class="reasoning">${esc(d.reasoning || '')}</div>
    </div>`;
  }

  // Contact
  if (d.contact_who) {
    html += `
    <div class="contact-card">
      <div class="label">Contact</div>
      <div class="value">${esc(d.contact_who)}</div>
    </div>`;
  }

  // Engagement hook
  if (d.engagement_hook) {
    html += `<div class="hook-card">${esc(d.engagement_hook)}</div>`;
  }

  // Key evidence
  if (d.key_evidence && d.key_evidence.length > 0) {
    html += `<div class="detail-section"><h3>Key Evidence</h3><ul>`;
    d.key_evidence.forEach(e => { html += `<li>${esc(e)}</li>`; });
    html += `</ul></div>`;
  }

  // Data gaps
  if (d.data_gaps && d.data_gaps.length > 0) {
    html += `<div class="detail-section"><h3>Data Gaps</h3><ul>`;
    d.data_gaps.forEach(g => { html += `<li>${esc(g)}</li>`; });
    html += `</ul></div>`;
  }

  // Description
  if (d.description) {
    html += `<div class="detail-section"><h3>Description</h3><p>${esc(d.description)}</p></div>`;
  }

  // Links
  const links = [];
  if (d.website) links.push(['Website', d.website]);
  if (d.email) links.push(['Email', 'mailto:' + d.email]);
  if (d.linkedin) links.push(['LinkedIn', d.linkedin]);
  if (d.github_org) links.push(['GitHub', 'https://github.com/' + d.github_org]);
  if (d.team_page) links.push(['Team', d.team_page]);
  if (links.length > 0) {
    html += `<div class="detail-section"><h3>Links</h3><div class="link-row">`;
    links.forEach(([label, url]) => {
      html += `<a href="${esc(url)}" target="_blank" class="link-pill">${esc(label)}</a>`;
    });
    html += `</div></div>`;
  }

  // Extra info
  const extras = [];
  if (d.team_size) extras.push(`Team size: ${d.team_size}`);
  if (d.sponsors) extras.push(`Sponsors: ${d.sponsors}`);
  if (d.competitions) extras.push(`Competitions: ${d.competitions}`);
  if (extras.length > 0) {
    html += `<div class="detail-section"><h3>Additional Info</h3><ul>`;
    extras.forEach(e => { html += `<li>${esc(e)}</li>`; });
    html += `</ul></div>`;
  }

  // Enrichments
  if (d.enrichments && d.enrichments.length > 0) {
    html += `<div class="detail-section"><h3>Enrichment Sources</h3><ul>`;
    d.enrichments.forEach(e => {
      html += `<li>${esc(e.source_type)} — ${esc(e.fetched_at.split('T')[0])}</li>`;
    });
    html += `</ul></div>`;
  }

  // Actions
  html += `
    <div class="detail-actions">
      <button class="btn btn-sm" onclick="enrichOne(${d.id})">Enrich</button>
      <button class="btn btn-sm btn-primary" onclick="scoreOne(${d.id})">Score</button>
    </div>`;

  el.innerHTML = html;
}

// ---------------------------------------------------------------------------
// Import
// ---------------------------------------------------------------------------
function showImport() {
  document.getElementById('import-overlay').classList.remove('hidden');
}
function hideImport() {
  document.getElementById('import-overlay').classList.add('hidden');
}

document.getElementById('import-overlay').addEventListener('click', e => {
  if (e.target === document.getElementById('import-overlay')) hideImport();
});
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') hideImport();
});

// Drag and drop
const importBox = document.getElementById('import-box');
importBox.addEventListener('dragover', e => { e.preventDefault(); importBox.classList.add('dragover'); });
importBox.addEventListener('dragleave', () => importBox.classList.remove('dragover'));
importBox.addEventListener('drop', e => {
  e.preventDefault();
  importBox.classList.remove('dragover');
  const file = e.dataTransfer.files[0];
  if (file) uploadFile(file);
});

document.getElementById('file-input').addEventListener('change', e => {
  const file = e.target.files[0];
  if (file) uploadFile(file);
});

async function uploadFile(file) {
  if (!file.name.endsWith('.xlsx')) {
    alert('Please select an .xlsx file');
    return;
  }
  const fd = new FormData();
  fd.append('file', file);
  try {
    const result = await api('POST', '/api/import', fd);
    hideImport();
    alert(`Imported ${result.total_imported} initiatives (${result.spin_off_count} spin-off targets, ${result.all_initiatives_count} all initiatives, ${result.duplicates_updated} updated)`);
    loadInitiatives();
  } catch (err) {
    alert('Import failed: ' + err.message);
  }
}

// ---------------------------------------------------------------------------
// Enrich & Score (single)
// ---------------------------------------------------------------------------
async function enrichOne(id) {
  try {
    const r = await api('POST', `/api/enrich/${id}`);
    alert(`Added ${r.enrichments_added} enrichments`);
    loadDetail(id);
    loadStats();
  } catch (err) {
    alert('Enrich failed: ' + err.message);
  }
}

async function scoreOne(id) {
  try {
    const r = await api('POST', `/api/score/${id}`);
    alert(`Verdict: ${r.verdict} (${r.score})`);
    loadDetail(id);
    loadInitiatives();
  } catch (err) {
    alert('Score failed: ' + err.message);
  }
}

// ---------------------------------------------------------------------------
// Batch operations via SSE (streaming fetch)
// ---------------------------------------------------------------------------
async function streamBatch(url, body) {
  const container = document.getElementById('progress-container');
  const label = document.getElementById('progress-label');
  const fill = document.getElementById('progress-fill');
  container.classList.add('active');
  fill.style.width = '0%';

  try {
    const resp = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body || {}),
    });

    const reader = resp.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      buffer += decoder.decode(value, { stream: true });

      const lines = buffer.split('\n');
      buffer = lines.pop() || '';

      for (const line of lines) {
        if (!line.startsWith('data: ')) continue;
        try {
          const event = JSON.parse(line.slice(6));
          if (event.type === 'progress') {
            const pct = Math.round((event.current / event.total) * 100);
            fill.style.width = pct + '%';
            label.textContent = `${event.current}/${event.total} — ${event.name}`;
          } else if (event.type === 'complete') {
            label.textContent = `Done! ${JSON.stringify(event.stats)}`;
            setTimeout(() => container.classList.remove('active'), 3000);
            loadInitiatives();
          }
        } catch {}
      }
    }
  } catch (err) {
    label.textContent = `Error: ${err.message}`;
    setTimeout(() => container.classList.remove('active'), 5000);
  }
}

function enrichBatch() { streamBatch('/api/enrich/batch', null); }
function scoreBatch() { streamBatch('/api/score/batch', null); }

// ---------------------------------------------------------------------------
// Keyboard navigation
// ---------------------------------------------------------------------------
document.addEventListener('keydown', e => {
  if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'SELECT') return;
  if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
    e.preventDefault();
    const items = state.initiatives;
    if (items.length === 0) return;
    const idx = items.findIndex(i => i.id === state.selectedId);
    let next;
    if (e.key === 'ArrowDown') next = Math.min(idx + 1, items.length - 1);
    else next = Math.max(idx - 1, 0);
    if (next >= 0 && next < items.length) {
      loadDetail(items[next].id);
      // Scroll into view
      const row = document.querySelector(`tr[data-id="${items[next].id}"]`);
      if (row) row.scrollIntoView({ block: 'nearest' });
    }
  }
});

// ---------------------------------------------------------------------------
// Utility
// ---------------------------------------------------------------------------
function esc(s) {
  if (!s) return '';
  const div = document.createElement('div');
  div.textContent = String(s);
  return div.innerHTML;
}

// ---------------------------------------------------------------------------
// Init
// ---------------------------------------------------------------------------
loadInitiatives();
</script>
</body>
</html>
